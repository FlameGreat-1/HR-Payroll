{% extends 'base.html' %}
{% load static %}

{% block title %}Bulk Employee Upload - HR Payroll System{% endblock %}

{% block extra_css %}
<style>
    .bulk-upload-container {
        max-width: 1000px;
        margin: 0 auto;
    }

    .upload-header {
        background: var(--text-white);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        text-align: center;
        border-left: 5px solid var(--primary-start);
    }

    .upload-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        font-size: 2.5rem;
        color: var(--text-white);
        box-shadow: var(--shadow-glow);
    }

    .upload-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .upload-subtitle {
        color: #6c757d;
        font-size: 1.1rem;
        margin-bottom: 0;
    }

    .upload-steps {
        background: var(--text-white);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .steps-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
    }

    .steps-title i {
        margin-right: 0.75rem;
        color: var(--primary-start);
    }

    .step-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid var(--primary-start);
    }

    .step-item:last-child {
        margin-bottom: 0;
    }

    .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--primary-gradient);
        color: var(--text-white);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .step-content {
        flex: 1;
    }

    .step-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
        font-size: 0.95rem;
    }

    .step-description {
        color: #6c757d;
        font-size: 0.85rem;
        margin: 0;
    }

    .template-download {
        background: var(--text-white);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        text-align: center;
    }

    .template-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .template-title i {
        margin-right: 0.75rem;
        color: var(--primary-start);
    }

    .template-description {
        color: #6c757d;
        margin-bottom: 1.5rem;
        font-size: 1rem;
    }

    .download-template-btn {
        background: #28a745;
        border: none;
        color: var(--text-white);
        font-weight: 600;
        padding: 0.75rem 2rem;
        border-radius: 10px;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .download-template-btn:hover {
        background: #218838;
        color: var(--text-white);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        text-decoration: none;
    }

    .download-template-btn i {
        margin-right: 0.5rem;
    }

    .upload-area {
        background: var(--text-white);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .upload-zone {
        border: 3px dashed #dee2e6;
        border-radius: 15px;
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        background-color: #f8f9fa;
    }

    .upload-zone.dragover {
        border-color: var(--primary-start);
        background-color: rgba(61, 90, 254, 0.05);
        transform: scale(1.02);
    }

    .upload-zone.has-file {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.05);
    }

    .upload-zone.error {
        border-color: #dc3545;
        background-color: rgba(220, 53, 69, 0.05);
    }

    .upload-icon-large {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .upload-zone.dragover .upload-icon-large {
        color: var(--primary-start);
        transform: scale(1.1);
    }

    .upload-zone.has-file .upload-icon-large {
        color: #28a745;
    }

    .upload-zone.error .upload-icon-large {
        color: #dc3545;
    }

    .upload-text {
        font-size: 1.2rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .upload-subtext {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
    }

    .file-input {
        display: none;
    }

    .browse-btn {
        background: var(--primary-gradient);
        border: none;
        color: var(--text-white);
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-glow);
    }

    .browse-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(213, 0, 249, 0.4);
    }

    .file-info {
        display: none;
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        border-left: 4px solid var(--primary-start);
    }

    .file-info.show {
        display: block;
    }

    .file-details {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .file-name {
        font-weight: 600;
        color: #333;
        display: flex;
        align-items: center;
    }

    .file-name i {
        margin-right: 0.5rem;
        color: #28a745;
    }

    .file-size {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .remove-file-btn {
        background: #dc3545;
        border: none;
        color: var(--text-white);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        transition: all 0.3s ease;
    }

    .remove-file-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
    }

    .upload-progress {
        display: none;
        margin-top: 1rem;
    }

    .upload-progress.show {
        display: block;
    }

    .progress {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        overflow: hidden;
    }

    .progress-bar {
        background: var(--primary-gradient);
        transition: width 0.3s ease;
    }

    .progress-text {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.5rem;
        text-align: center;
    }

    .validation-results {
        display: none;
        background: var(--text-white);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .validation-results.show {
        display: block;
    }

    .validation-header {
        display: flex;
        align-items: center;
        justify-content: between;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f8f9fa;
    }

    .validation-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #333;
        display: flex;
        align-items: center;
    }

    .validation-title i {
        margin-right: 0.75rem;
        color: var(--primary-start);
    }

    .validation-stats {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
        border-radius: 10px;
        flex: 1;
    }

    .stat-item.success {
        background-color: rgba(40, 167, 69, 0.1);
        border-left: 4px solid #28a745;
    }

    .stat-item.error {
        background-color: rgba(220, 53, 69, 0.1);
        border-left: 4px solid #dc3545;
    }

    .stat-item.warning {
        background-color: rgba(255, 193, 7, 0.1);
        border-left: 4px solid #ffc107;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .stat-number.success { color: #28a745; }
    .stat-number.error { color: #dc3545; }
    .stat-number.warning { color: #ffc107; }

    .stat-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #6c757d;
    }

    .error-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background-color: #fff;
    }

    .error-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f8f9fa;
        display: flex;
        align-items: center;
    }

    .error-item:last-child {
        border-bottom: none;
    }

    .error-icon {
        color: #dc3545;
        margin-right: 0.75rem;
        font-size: 0.9rem;
    }

    .error-text {
        flex: 1;
        font-size: 0.85rem;
        color: #333;
    }

    .row-number {
        background-color: #6c757d;
        color: var(--text-white);
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    .upload-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }

    .process-btn {
        background: var(--primary-gradient);
        border: none;
        color: var(--text-white);
        font-weight: 700;
        font-size: 1.1rem;
        padding: 1rem 2.5rem;
        border-radius: 12px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-glow);
        position: relative;
        overflow: hidden;
        min-width: 200px;
    }

    .process-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(213, 0, 249, 0.4);
    }

    .process-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }

    .cancel-upload-btn {
        background: transparent;
        border: 2px solid #6c757d;
        color: #6c757d;
        font-weight: 600;
        padding: 1rem 2.5rem;
        border-radius: 12px;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        min-width: 200px;
    }

    .cancel-upload-btn:hover {
        background-color: #6c757d;
        color: var(--text-white);
        transform: translateY(-2px);
        text-decoration: none;
    }

    .loading-spinner {
        display: none;
        margin-right: 0.5rem;
    }

    .process-btn.loading .loading-spinner {
        display: inline-block;
    }

    .process-btn.loading .btn-text {
        opacity: 0.7;
    }

    @media (max-width: 768px) {
        .bulk-upload-container {
            padding: 0 1rem;
        }

        .upload-header {
            padding: 1.5rem;
        }

        .upload-icon {
            width: 60px;
            height: 60px;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .upload-title {
            font-size: 1.8rem;
        }

        .upload-steps,
        .template-download,
        .upload-area,
        .validation-results {
            padding: 1.5rem;
        }

        .upload-zone {
            padding: 2rem 1rem;
        }

        .upload-icon-large {
            font-size: 3rem;
        }

        .validation-stats {
            flex-direction: column;
            gap: 1rem;
        }

        .upload-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .process-btn,
        .cancel-upload-btn {
            min-width: auto;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="bulk-upload-container">
    <div class="upload-header">
        <div class="upload-icon">
            <i class="bi bi-cloud-upload"></i>
        </div>
        <h1 class="upload-title">Bulk Employee Upload</h1>
        <p class="upload-subtitle">
            Upload multiple employees at once using an Excel file
        </p>
    </div>

    <div class="upload-steps">
        <h3 class="steps-title">
            <i class="bi bi-list-ol"></i>
            How to Upload Employees
        </h3>
        <div class="step-item">
            <div class="step-number">1</div>
            <div class="step-content">
                <div class="step-title">Download Template</div>
                <p class="step-description">Download the Excel template with the required format and column headers</p>
            </div>
        </div>
        <div class="step-item">
            <div class="step-number">2</div>
            <div class="step-content">
                <div class="step-title">Fill Employee Data</div>
                <p class="step-description">Enter employee information in the template following the format guidelines</p>
            </div>
        </div>
        <div class="step-item">
            <div class="step-number">3</div>
            <div class="step-content">
                <div class="step-title">Upload File</div>
                <p class="step-description">Upload your completed Excel file using the upload area below</p>
            </div>
        </div>
        <div class="step-item">
            <div class="step-number">4</div>
            <div class="step-content">
                <div class="step-title">Review & Process</div>
                <p class="step-description">Review validation results and process the upload to create employee accounts</p>
            </div>
        </div>
    </div>

    <div class="template-download">
        <h3 class="template-title">
            <i class="bi bi-file-earmark-excel"></i>
            Download Template
        </h3>
        <p class="template-description">
            Download the Excel template with pre-defined columns and sample data to ensure proper formatting
        </p>
        <a href="{% url 'accounts:download_template' %}" class="download-template-btn">
            <i class="bi bi-download"></i>
            Download Excel Template
        </a>
    </div>

    <div class="upload-area">
        <form method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon-large">
                    <i class="bi bi-cloud-upload" id="uploadIcon"></i>
                </div>
                <div class="upload-text" id="uploadText">Drag and drop your Excel file here</div>
                <div class="upload-subtext" id="uploadSubtext">or click to browse and select file</div>
                <button type="button" class="btn browse-btn" id="browseBtn">
                    <i class="bi bi-folder2-open"></i>
                    Browse Files
                </button>
                <input type="file" name="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
            </div>

            <div class="file-info" id="fileInfo">
                <div class="file-details">
                    <div class="file-name" id="fileName">
                        <i class="bi bi-file-earmark-excel"></i>
                        <span id="fileNameText"></span>
                    </div>
                    <div class="file-size" id="fileSize"></div>
                    <button type="button" class="btn remove-file-btn" id="removeFileBtn">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="upload-progress" id="uploadProgress">
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">Uploading...</div>
                </div>
            </div>
        </form>
    </div>

    <div class="validation-results" id="validationResults">
        <div class="validation-header">
            <h3 class="validation-title">
                <i class="bi bi-check-circle"></i>
                Validation Results
            </h3>
        </div>

        <div class="validation-stats">
            <div class="stat-item success">
                <div class="stat-number success" id="validRecords">0</div>
                <div class="stat-label">Valid Records</div>
            </div>
            <div class="stat-item error">
                <div class="stat-number error" id="errorRecords">0</div>
                <div class="stat-label">Errors Found</div>
            </div>
            <div class="stat-item warning">
                <div class="stat-number warning" id="totalRecords">0</div>
                <div class="stat-label">Total Records</div>
            </div>
        </div>

        <div id="errorSection" style="display: none;">
            <h4 style="color: #dc3545; margin-bottom: 1rem;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Errors Found
            </h4>
            <div class="error-list" id="errorList"></div>
        </div>

        <div class="upload-actions">
            <button type="button" class="btn process-btn" id="processBtn" disabled>
                <span class="loading-spinner spinner-border spinner-border-sm" role="status"></span>
                <span class="btn-text">Process Upload</span>
            </button>
            <a href="{% url 'accounts:employee_list' %}" class="cancel-upload-btn">
                Cancel
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileNameText');
    const fileSize = document.getElementById('fileSize');
    const removeFileBtn = document.getElementById('removeFileBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const validationResults = document.getElementById('validationResults');
    const processBtn = document.getElementById('processBtn');
    const uploadForm = document.getElementById('uploadForm');
    const uploadIcon = document.getElementById('uploadIcon');
    const uploadText = document.getElementById('uploadText');
    const uploadSubtext = document.getElementById('uploadSubtext');

    let selectedFile = null;
    let validationData = null;

    uploadZone.addEventListener('click', () => fileInput.click());
    browseBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        fileInput.click();
    });

    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    removeFileBtn.addEventListener('click', () => {
        resetUpload();
    });

    function handleFileSelect(file) {
        if (!validateFile(file)) return;

        selectedFile = file;
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        
        uploadZone.classList.add('has-file');
        uploadIcon.className = 'bi bi-file-earmark-excel';
        uploadText.textContent = 'File selected successfully';
        uploadSubtext.textContent = 'Click process to validate and upload';
        
        fileInfo.classList.add('show');
        uploadFile();
    }

    function validateFile(file) {
        const allowedTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'];
        const maxSize = 10 * 1024 * 1024; // 10MB

        if (!allowedTypes.includes(file.type)) {
            alert('Please select a valid Excel file (.xlsx or .xls)');
            return false;
        }

        if (file.size > maxSize) {
            alert('File size must be less than 10MB');
            return false;
        }

        return true;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function uploadFile() {
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        uploadProgress.classList.add('show');
        progressBar.style.width = '0%';
        progressText.textContent = 'Validating file...';

        fetch('{% url "accounts:bulk_upload" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            uploadProgress.classList.remove('show');
            
            if (data.success) {
                showValidationResults(data);
            } else {
                showError(data.error || 'Upload failed');
            }
        })
        .catch(error => {
            uploadProgress.classList.remove('show');
            showError('An error occurred during upload');
        });

        // Simulate progress
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 200);

        setTimeout(() => {
            clearInterval(interval);
            progressBar.style.width = '100%';
        }, 2000);
    }

    function showValidationResults(data) {
        validationData = data;
        
        document.getElementById('validRecords').textContent = data.valid_count || 0;
        document.getElementById('errorRecords').textContent = data.error_count || 0;
        document.getElementById('totalRecords').textContent = data.total_count || 0;

        if (data.errors && data.errors.length > 0) {
            showErrors(data.errors);
            processBtn.disabled = true;
        } else {
            document.getElementById('errorSection').style.display = 'none';
            processBtn.disabled = false;
        }

        validationResults.classList.add('show');
    }

    function showErrors(errors) {
        const errorList = document.getElementById('errorList');
        const errorSection = document.getElementById('errorSection');
        
        errorList.innerHTML = '';
        errors.forEach(error => {
            const errorItem = document.createElement('div');
            errorItem.className = 'error-item';
            errorItem.innerHTML = `
                <i class="bi bi-exclamation-circle error-icon"></i>
                <span class="error-text">${error.message}</span>
                <span class="row-number">Row ${error.row}</span>
            `;
            errorList.appendChild(errorItem);
        });
        
        errorSection.style.display = 'block';
    }

    function showError(message) {
        uploadZone.classList.add('error');
        uploadIcon.className = 'bi bi-exclamation-triangle';
        uploadText.textContent = 'Upload failed';
        uploadSubtext.textContent = message;
        
        setTimeout(() => {
            resetUpload();
        }, 3000);
    }

    function resetUpload() {
        selectedFile = null;
        validationData = null;
        fileInput.value = '';
        
        uploadZone.classList.remove('has-file', 'error');
        uploadIcon.className = 'bi bi-cloud-upload';
        uploadText.textContent = 'Drag and drop your Excel file here';
        uploadSubtext.textContent = 'or click to browse and select file';
        
        fileInfo.classList.remove('show');
        uploadProgress.classList.remove('show');
        validationResults.classList.remove('show');
        
        processBtn.disabled = true;
    }

    processBtn.addEventListener('click', function() {
        if (!validationData) return;

        this.classList.add('loading');
        this.disabled = true;

        fetch('{% url "accounts:process_bulk_upload" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                file_data: validationData.file_data
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully created ${data.created_count} employee accounts!`);
                window.location.href = '{% url "accounts:employee_list" %}';
            } else {
                alert('Error processing upload: ' + data.error);
                this.classList.remove('loading');
                this.disabled = false;
            }
        })
        .catch(error => {
            alert('An error occurred while processing the upload');
            this.classList.remove('loading');
            this.disabled = false;
        });
    });
});
</script>
{% endblock %}

